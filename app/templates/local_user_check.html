{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "_macros.html" as macros %}


{% block subheader %}
    <div class="m-subheader ">
        <div class="d-flex align-items-center">
            <div class="mr-auto">
                <h3 class="m-subheader__title m-subheader__title--separator">
                    系统管理
                </h3>
                <ul class="m-subheader__breadcrumbs m-nav m-nav--inline">
                    <li class="m-nav__item m-nav__item--home">
                        <a href="#" class="m-nav__link m-nav__link--icon">
                            <i class="m-nav__link-icon la la-home"></i>
                        </a>
                    </li>
                    <li class="m-nav__separator">
                        -
                    </li>
                    <li class="m-nav__item">
                        <a href="" class="m-nav__link">
											<span class="m-nav__link-text">
												系统管理
											</span>
                        </a>
                    </li>
                    <li class="m-nav__separator">
                        -
                    </li>
                    <li class="m-nav__item">
                        <a href="" class="m-nav__link">
											<span class="m-nav__link-text">
												用户查询
											</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
{% endblock %}


{% block pagecontent %}
    <div class="m-portlet">
        <div class="m-portlet__head">
            <div class="m-portlet__head-caption">
                <div class="m-portlet__head-title">
                    <h3 class="m-portlet__head-text">
                        用户信息
                    </h3>
                </div>
            </div>
            <div class="m-portlet__head-tools">
                <ul class="m-portlet__nav">
                    <li class="m-portlet__nav-item">
                        <a id="newOne" class="m-portlet__nav-link m-portlet__nav-link--icon">
                            <i class="flaticon-add"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="m-portlet__body">
            <div class="m-portlet__body">
                <div class="m_datatable" id="ajax_data"></div>
            </div>
        </div>
    </div>


    <!-- 模态框（Modal） -->
    <div class="modal fade" id="update" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">
                        修改用户信息
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
											<span aria-hidden="true">
												&times;
											</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>用户ID: <input type="text" name="id" id="id" readonly="true" style="border-style:none"/></p>
                    <p>账户（Email）: <input type="text" name="email_account" id="email_account" readonly="true" style="border-style:none"/>
                    </p>
                    <p>{{ wtf.form_field(modal_form.username, id='username') }}</p>
                    <p>{{ wtf.form_field(modal_form.phone_number, id='phone_number') }}</p>
                    <p>{{ wtf.form_field(modal_form.password, id='pass') }}</p>
                    <p>{{ wtf.form_field(modal_form.role, id='role') }}</p>
                    <p>{{ wtf.form_field(modal_form.area, id='area') }}</p>
                    <p>{{ wtf.form_field(modal_form.duty, id='duty') }}</p>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="update()">提交更改</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal -->
    </div>
    <!-- 模态框（Modal）end -->

    <!-- 模态框（Modal） -->
    <div class="modal fade" id="user_register_model" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">
                        添加新用户
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
											<span aria-hidden="true">
												&times;
											</span>
                    </button>
                </div>
                <form class="m-form m-form--fit m-form--label-align-right" id="m_form_1">
                    <div class="modal-body">
                        <div class="m-form__content">
                            <div class="m-alert m-alert--icon alert alert-danger m--hide" role="alert"
                                 id="m_form_1_msg">
                                <div class="m-alert__icon">
                                    <i class="la la-warning"></i>
                                </div>
                                <div class="m-alert__text">
                                    填写信息有误，请检查重填后再次提交！
                                </div>
                                <div class="m-alert__close">
                                    <button type="button" class="close" data-close="alert" aria-label="Close"></button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-3 col-sm-12">
                                用户名 *
                            </label>
                            <div class="col-lg-6 col-md-9 col-sm-12">
                                <input type="text" class="form-control m-input" name="username"
                                       placeholder="请输入姓名" data-toggle="m-tooltip"
                                       title="不能有特殊符号" id="username_new">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-3 col-sm-12">
                                Email *
                            </label>
                            <div class="col-lg-6 col-md-9 col-sm-12">
                                <input type="text" class="form-control m-input" name="email"
                                       placeholder="Enter your email" data-toggle="m-tooltip"
                                       title="将作为登陆账号" id="email">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-3 col-sm-12">
                                手机号 *
                            </label>
                            <div class="col-lg-6 col-md-9 col-sm-12">
                                <div class="input-group">
                                    <input type="text" class="form-control m-input" name="phone"
                                           placeholder="输入有效的手机号码" id="phone">
                                </div>
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-3 col-sm-12">
                                密码 *
                            </label>
                            <div class="col-lg-6 col-md-9 col-sm-12">
                                <input class="form-control m-input" name="password"
                                       placeholder="请输入密码" data-toggle="m-tooltip" type="password" id="password">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-3 col-sm-12">
                                校验密码 *
                            </label>
                            <div class="col-lg-6 col-md-9 col-sm-12">
                                <input class="form-control m-input" name="password2"
                                       placeholder="请再次输入密码" data-toggle="m-tooltip" type="password" id="password2">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-3 col-sm-12">
                                权限 *
                            </label>
                            <div class="col-lg-6 col-md-9 col-sm-12">
                                <select class="form-control m-input m-input--air" name="role_select" id="role_select">
                                    <option value="" selected="selected">请选择权限</option>
                                    {% for r in role %}
                                        <option value={{ r[0] }}>{{ r[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-3 col-sm-12">
                                职务
                            </label>
                            <div class="col-lg-6 col-md-9 col-sm-12">
                                <select class="form-control m-input m-input--air" name="duty_select" id="duty_select">
                                    <option value="" selected="selected">请选择职务</option>
                                    {% for r in duty_choice %}
                                        <option value={{ r[0] }}>{{ r[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-3 col-sm-12">
                                区域 *
                            </label>
                            <div class="col-lg-6 col-md-9 col-sm-12">
                                <select class="form-control m-input m-input--air" name="area_select" id="area_select">
                                    <option value="" selected="selected">请选择管辖区域</option>
                                    {% for r in area %}
                                        <option value={{ r[0] }}>{{ r[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-3 col-sm-12">
                                机房
                            </label>
                            <div class="col-lg-6 col-md-9 col-sm-12">
                                <select class="form-control m-input" name="machine_room_select" multiple size="9"
                                        id="machine_room_select">
                                    {% for r in machine_room_name %}
                                        <option value={{ r[0] }}>{{ r[1] }}</option>
                                    {% endfor %}
                                </select>
                                <span class="m-form__help">
												若此处选择了机房，则该账户管辖机房范围以所选机房为准
											</span>
                            </div>

                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <input class="btn btn-default" id="submit" name="submit" value="提交" type="submit">
                    </div>
                </form>

                <div class="holder">
                </div>
                <ul class="posts" id="itemContainer">
                </ul>
                <div class="holder">
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal -->
    </div>
    <!-- 模态框（Modal）end -->
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="../static/metronic/form-controls.js"></script>
    <script>

        $("#newOne").click(function () {
            $("#user_register_model").removeData("bs.modal").modal('show')
        });

        function editInfo(id, username, phone, email) {
            $('#update').find("input,textarea,select").val('').end();

            $('#id').val(id);
            $('#email_account').val(email);
            $('#username').val(username);
            $('#phone_number').val(phone);


        }

        //提交更改
        function update() {
            //获取模态框数据
            var pass = $('#pass').val();
            var id = $('#id').val();
            var username = $('#username').val();
            var role = $('#role').val();
            var area = $('#area').val();
            var duty = $('#duty').val();
            var phone_number = $("#phone_number").val();
            var reg = /^1[3|4|5|7|8][0-9]{9}$/;
            if (reg.test(phone_number) || !phone_number) {
                $.ajax({
                    type: "post",
                    url: "userinfo_update",
                    data: "&pass=" + pass + "&id=" + id + "&username=" + username + "&role=" + role + "&area=" + area + "&duty=" + duty + "&phone_number=" + phone_number,
                    dataType: 'json',
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    success: function (msg) {
                        if (msg.status === 'ok') {
                            toastr.info(msg.content);
                            $('#ajax_data').mDatatable().destroy();
                            DatatableRemoteAjaxDemo.init();
                            $('#update').modal('hide')
                        }
                        else {
                            toastr.warning(msg.content);
                            $('#update').modal('hide')
                        }

                    }
                });
            }
            else {
                toastr.warning("请输入正确的手机号");
            }
        }

        $("#user_register_model").on("hidden.bs.modal", function () {
            $(this).find("input,textarea,select").val('').end();
        });

        $("#update").on("hidden.bs.modal", function () {
            $(this).find("input,textarea,select").val('').end();
        });


        function HTMerDel(user_id) {
            if (confirm("确定要删除该信息吗？删除将不能恢复！")) {
                var params = {'user_id': user_id};
                var this_modal = $('#update');
                $.ajax({
                    type: "POST",          //提交方式          
                    url: "user_delete",  //提交的页面/方法名          
                    data: JSON.stringify(params, null, '\t'),         //参数（如果没有参数：null）          
                    contentType: "application/json; charset=utf-8",
                    success: function (msg) {
                        if (msg.status === 'OK') {
                            toastr.info(msg.content);
                            $('#ajax_data').mDatatable().destroy();
                            DatatableRemoteAjaxDemo.init();

                        }
                        else {
                            toastr.warning(msg.content);
                        }

                    },
                    error: function (xhr, msg, e) {
                        toastr.warning("删除失败");
                    }
                });
            }
            else {
                toastr.warning('取消删除')
            }
        }


        $(function () {
            //参数设置，若用默认值可以省略以下面代
            toastr.options = {
                "closeButton": true, //是否显示关闭按钮
                "debug": false, //是否使用debug模式
                "progressBar": false,
                "positionClass": "toast-bottom-center",//弹出窗的位置
                "showDuration": "300",//显示的动画时间
                "hideDuration": "1000",//消失的动画时间
                "timeOut": "5000", //展现时间
                "extendedTimeOut": "1000",//加长展示时间
                "showEasing": "swing",//显示时的动画缓冲方式
                "hideEasing": "linear",//消失时的动画缓冲方式
                "showMethod": "fadeIn",//显示时的动画方式
                "hideMethod": "fadeOut" //消失时的动画方式
            };
        })
    </script>
    <script src="../static/metronic/local_user_check.js" type="text/javascript"></script>
{% endblock %}